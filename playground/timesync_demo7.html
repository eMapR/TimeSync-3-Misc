<!DOCTYPE html>
<html lan="en">
	<head>
		<title>TimeSync</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="X-UA-Compatible" content="IE=edge"> <!--needed so that D3 will work in IE!-->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
		<link rel="stylesheet" href="timesync_style.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
		<!--<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>!-->
		<script type="text/javascript" src="jquery.mousewheel.min.js"></script>
		<script type="text/javascript" src="specIndexStretch.js"></script>
		<style>


			
			
		</style>
	</head>
	<body> <!-- onload="drawAllChips()" -->
			
			<div id="topSection">
				<p id="title" style="display:inline-block;">TimeSync - v3.0</p>
				<div id="chipInputs" style="display:inline-block;">
					<div id="chipSizeDiv" style="display:inline-block;">
						<p style="display:inline-block;">Chip Size:</p>
						<div style="display:inline-block;">
							<div id="chipSize" class="chipInputsEdit">195</div>
							<div id="chipSizeList" class="dropThis">
								<ul>
									<li>95</li>
									<li>195</li>
									<li>255</li>
								</ul>
							</div>
						</div>
					</div>
					<div style="display:inline-block;">
						<p style="display:inline-block;">Plot Size:</p>
						<div style="display:inline-block;">
							<div id="plotSize" class="chipInputsEdit">1</div>
							<div id="plotSizeList" class="dropThis">
								<ul>
									<li>1</li>
									<li>9</li>
									<li>25</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
				
				
				
				<!-- <input id="plotSize" autocomplete="off" type="text" name="FirstName" value="1"></p> -->
			</div>
			<div id="containerDiv">
				<div id="plotSelectionDiv" class="sectionDiv">
					<p class="header">Plots</p>
					<ul> <!-- the <li>'s will be filled in on-the-fly -->
						<li class="plotList selected">123
						<li class="plotList unselected">456
						<li class="plotList unselected">789
						<li class="plotList unselected">456
						<li class="plotList unselected">789
						<li class="plotList unselected">456
						<li class="plotList unselected">789
						<li class="plotList unselected">456
						<li class="plotList unselected">789
						<li class="plotList unselected">456
						<li class="plotList unselected">789
						<li class="plotList unselected">456
						<li class="plotList unselected">789
						<li class="plotList unselected">456
						<li class="plotList unselected">789
						<li class="plotList unselected">456
						<li class="plotList unselected">789
						<li class="plotList unselected">456
						<li class="plotList unselected">789						
						<li class="plotList unselected">456
						<li class="plotList unselected">789
						<li class="plotList unselected">456
						<li class="plotList unselected">789
						<li class="plotList unselected">456
						<li class="plotList unselected">789						
						<li class="plotList unselected">456
						<li class="plotList unselected">789
						<li class="plotList unselected">456
						<li class="plotList unselected">789
					</ul>
				</div>
				<div id="plot" class="sectionDiv">
					<p class="header">Spectral Trajectory</p>
					<svg id="svg" width="740" height="250"></svg>
					<div class="btn-group" role="group" aria-label="..." style="margin:-1px; display: inline-block;">
						<div class="btn-group dropdown" role="group">	
							<button id="btnIndex" class="btn btn-default dropdown-toggle specPlotBtn" type="button">
								<div><strong>Index</strong>:<br><small>TC Wetness</small><span class="caret"></span></div>
							</button>
							<ul class="dropdown-menu plot" id="index-list">
								<li class="" id="B1">Band 1</li>
								<li class="" id="B2">Band 2</li>
								<li class="" href="#" id="B3">Band 3</li>
								<li class="" href="#" id="B4">Band 4</li>
								<li class="" href="#" id="B5">Band 5</li>
								<li class="" href="#" id="B7">Band 7</li>
								<li class="" href="#" id="TCB">TC Brightness</li>
								<li class="" href="#" id="TCG">TC Greenness</li>
								<li class="active" href="#" id="TCW">TC Wetness</li>
								<li class="" href="#" id="TCA">TC Angle</li>
								<li class="" href="#" id="NDVI">NDVI</li>
								<li class="" href="#" id="NBR">NBR</li>
							</ul>
						</div>
						<div id="btnRed" class="btn-group dropdown" role="group">					
							<button class="btn btn-default dropdown-toggle specPlotBtn" type="button">
								<div><strong>R</strong><small>GB</small>:<br><small>TC Brightness</small><span class="caret"></span></div>
							</button>
							<ul class="dropdown-menu plot" id="red-list">
								<li class="" href="#" id="B1">Band 1</li>
								<li class="" href="#" id="B2">Band 2</li>
								<li class="" href="#" id="B3">Band 3</li>
								<li class="" href="#" id="B4">Band 4</li>
								<li class="" href="#" id="B5">Band 5</li>
								<li class="" href="#" id="B7">Band 7</li>
								<li class="active" href="#" id="TCB">TC Brightness</li>
								<li class="" href="#" id="TCG">TC Greenness</li>
								<li class="" href="#" id="TCW">TC Wetness</li>
								<li class="" href="#" id="TCA">TC Angle</li>
								<li class="" href="#" id="NDVI">NDVI</li>
								<li class="" href="#" id="NBR">NBR</li>
							</ul>
						</div>
						<div class="btn-group dropdown" role="group">
							<button id="btnGreen" class="btn btn-default dropdown-toggle specPlotBtn" type="button">
								<div><small>R</small><strong>G</strong><small>B</small>:<br><small>TC Greenness</small><span class="caret"></span></div>
							</button>
							<ul class="dropdown-menu plot" id="green-list">
								<li class="" href="#" id="B1">Band 1</li>
								<li class="" href="#" id="B2">Band 2</li>
								<li class="" href="#" id="B3">Band 3</li>
								<li class="" href="#" id="B4">Band 4</li>
								<li class="" href="#" id="B5">Band 5</li>
								<li class="" href="#" id="B7">Band 7</li>
								<li class="" href="#" id="TCB">TC Brightness</li>
								<li class="active" href="#" id="TCG">TC Greenness</li>
								<li class="" href="#" id="TCW">TC Wetness</li>
								<li class="" href="#" id="TCA">TC Angle</li>
								<li class="" href="#" id="NDVI">NDVI</li>
								<li class="" href="#" id="NBR">NBR</li>
							</ul>
						</div>
						<div class="btn-group dropdown" role="group">
							<button id="btnBlue" class="btn btn-default dropdown-toggle specPlotBtn" type="button">
								<div><small>RG</small><strong>B</strong>:<br><small>TC Wetness</small><span class="caret"></span></div>
							</button>
							<ul class="dropdown-menu plot" id="blue-list">
								<li class="" href="#" id="B1">Band 1</li>
								<li class="" href="#" id="B2">Band 2</li>
								<li class="" href="#" id="B3">Band 3</li>
								<li class="" href="#" id="B4">Band 4</li>
								<li class="" href="#" id="B5">Band 5</li>
								<li class="" href="#" id="B7">Band 7</li>
								<li class="" href="#" id="TCB">TC Brightness</li>
								<li class="" href="#" id="TCG">TC Greenness</li>
								<li class="active" href="#" id="TCW">TC Wetness</li>
								<li class="" href="#" id="TCA">TC Angle</li>
								<li class="" href="#" id="NDVI">NDVI</li>
								<li class="" href="#" id="NBR">NBR</li>
							</ul>
						</div>
						<div class="btn-group" role="group">
							<button id="btnLine" class="btn btn-default specPlotBtn" type="button">
								<Strong>Display line</strong>:<br><span id="lineDisplayThumb" class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span>
							</button>
						</div>
					</div>
				</div>
				
				
				<div class="sectionDiv">
					<p class="header">Trajectory Forms</p>
					<ul class="test">
						<li id="segmentsFormTab" class="selected" style="border-top-left-radius:4px; text-align:center;">Segments
						<li id="verticesFormTab" class="unselected" style="margin-left:-1px; border-top-right-radius:4px; text-align:center;">Vertices
					</ul>
					
					<div id="segmentsFormDiv">
						<table id="segmentsFormTbl">
							<col width="19">
							<col width="38">
							<col width="38">
							<tr class="trHeader">
								<th></th>
								<th>Start</th>
								<th>End</th>		
								<th>Change Process</th>
							</tr>
	<!-- 						<tr class="segment">
								<td class="highlightIt"><span class="glyphicon glyphicon-search"></span></td>
								<td>&nbsp;</td>
								<td>&nbsp;</td>		
								<td class="changeProcessInput formDrop"></td>
							</tr> -->
						</table>					
					</div>
									
					<div id="changeProcessDiv" class="dropThis">
						<p class="subHeader">Change process:</p>
						<div id="changeProcessSelection" class="formDropSelection" align="center"><span class="glyphicon glyphicon-triangle-bottom"></span></div> <!-- <div id="theSelection"></div> -->
						<ul id="changeProcessList">
							<li>Fire</li>
							<li>Harvest</li>
							<li>Decline</li>
							<li>Wind</li>
							<li>Hydrology</li>
							<li>Debris</li>
							<li>Growth</li>
							<li>Stable</li>
							<li>Conversion</li>
							<li>Other</li>
						</ul>
						<p class="subHeader">Notes:</p>
						<ul id="CPnotesList">
						</ul>
						<div id="changeProcessDoneBtn" class="doneBtn">Done</div>
					</div>
					
					
					
					<div id="verticesFormDiv">						
						<table id="verticesFormTbl">
							<col width="19">
							<col width="38">
							<col width="140">
							<tr class="trHeader">
								<th></th>
								<th>Year</th>
								<th>Land Use</th>
								<th>Land Cover</th>
							</tr>
	<!-- 						<tr class="vertex">
								<td class="highlightIt"><span class="glyphicon glyphicon-search"></span></td>
								<td></td>
								<td class="landUseInput formDrop"></td>	
								<td class="landCoverInput formDrop"></td>								
							</tr> -->
						</table>
					</div>
						
					<div id="landUseDiv" class="dropThis">
						<!-- <p class="subHeader">Land Use:</p> -->
						<div id="landUseSelection" class="formDropSelection" align="center"><span class="glyphicon glyphicon-triangle-bottom"></span></div> <!-- <div id="theSelection"></div> -->
						<ul id="landUseList">
							<li>Forest</li>
							<li>Developed</li>
							<li>Agriculture</li>
							<li>Non-forest Wetland</li>
							<li>Rangeland</li>
							<li>Other</li>
						</ul>
						<p class="subHeader">Notes:</p>
						<ul id="LUnotesList">
						</ul>
						<div id="landUseDoneBtn" class="doneBtn">Done</div>
					</div>

					<div id="landCoverDiv" class="dropThis">
						<!-- <p class="subHeader">Land Cover:</p> -->
						<div id="landCoverSelection" class="formDropSelection" align="center"><span class="glyphicon glyphicon-triangle-bottom"></span></div> <!-- <div id="theSelection"></div> -->
						<ul id="landCoverList">
							<li>Trees</li>
							<li>Shrubs</li>
							<li>Grass/forb/herb</li>
							<li>Impervious</li>
							<li>Natural barren</li>
							<li>Snow/ice</li>
							<li>Water</li>
						</ul>
						<p class="subHeader">Notes:</p>
						<ul id="LCnotesList">
							<li class="trees"><span class="glyphicon glyphicon-unchecked"></span> Trees</li>
							<li class="shrubs"><span class="glyphicon glyphicon-unchecked"></span> Shrubs</li>
							<li class="grassForbHerb"><span class="glyphicon glyphicon-unchecked"></span> Grass/forb/herb</li>
							<li class="impervious"><span class="glyphicon glyphicon-unchecked"></span> Impervious</li>
							<li class="naturalBarren"><span class="glyphicon glyphicon-unchecked"></span> Natural/barren</li>
							<li class="SnowIce"><span class="glyphicon glyphicon-unchecked"></span> Snow/ice</li>
							<li class="water"><span class="glyphicon glyphicon-unchecked"></span> Water</li>
						</ul>
						<div id="landCoverDoneBtn" class="doneBtn">Done</div>
					</div>	
					
				</div>
				
				<div id="commentsSection" class="sectionDiv">
					<p class="header">Comments</p>
					<div id="commentInputDiv" class="tableDisplayCell">
						<textarea id="commentInput" autocomplete="off"></textarea>
					</div>
				</div>




			</div>
			
			<div id="chipGallerySection">
				<p class="header">Image Chip Gallery</p>
				<div id="chip-gallery"></div>
			</div>
			<div id="img-gallery"></div>	

				
					



		
		
		<script>
	
			//////////DEFINE GLOBAL VARIABLES/////////////////////////////////////////////////////////						
			var n_stdev = 2,
				data = {}, // = getJson("./test3.json"), //get the data
				len = 0, // = Object.keys(data.Values).length, //get the number of years
				specIndex = "TCW", //default index to display	
				rgbColor,
				jsonURL = "./test3.json";
			
			
			/////////////DEFINE FUNCTIONS////////////////////////////////////////////////////////////////
			
			//function to retrieve json data
			$.getJSON(jsonURL).done(function(jsonobject){
				data = jsonobject
				len = data.Values.length; // NEEDS TO BE A GLOBAL VARIABLE
				//len = Object.keys(data.Values).length
				calcIndices();
				rgbColor = scaledRGB(data, "TCB", "TCG", "TCW", stretch, 2, len); //get the scaled rgb color
				plotInt();
				
				////make the trajectory svg circles selectable
				//$(document).ready(function(){
				//	$("circle").click(function(e){
				//		if(e.ctrlKey){
				//			e.preventDefault(); //make sure that default browser behaviour is prevented
				//			var status = $(this).attr("class");
				//			if(status == "unselected"){
				//				$(this).attr("class","selected");
				//			} else {
				//				$(this).attr("class","unselected");
				//			}	
				//		}
				//	});
				//});
				
			});
	
			//define function to update the circle selection
			function changeSelectedClass(seriesIndex){
				thisCircle = $("circle").eq(seriesIndex);
				thisCanvas = $("canvas").eq(seriesIndex);
				var status = thisCircle.attr("class");
				if(status == "unselected"){
					thisCircle.attr("class","selected");
					thisCanvas.attr("class","selected");
					changePlotLine();	
				} else {
					thisCircle.attr("class","unselected");
					thisCanvas.attr("class","unselected");
					changePlotLine();
				}
			}

			//make the trajectory svg circles selectable
			$(document).ready(function(){
				$(document).on("click", "circle, canvas", function(e){ //need to use this style event binding for elements that don't exisit yet - these lines will run before the "circle" elements are created, alternatively could use the commented lines in the above jquery section
					if(e.shiftKey){
						if($("tr").hasClass("active") == false){
							e.preventDefault(); //make sure that default browser behaviour is prevented
							var nodeType = $(this).prop('nodeName')
							if(nodeType == "circle"){
								var seriesIndex = $("circle").index(this);
							} else{
								var seriesIndex = $("canvas").index(this);
							}
							if(seriesIndex != 0 &&  seriesIndex != len-1){
								changeSelectedClass(seriesIndex)
							}					
						}
					}
				});
			});
			
			
			//define function to add and remove line segments
			var selectedCircles = [] //global
			function changePlotLine(){
				var selectedCirclesTemp = $("circle.selected"),
					lineData = [],
					i = 0;
				selectedCircles = [];
				for(i; i < selectedCirclesTemp.length; i++){
					var thisone = $("circle").index(selectedCirclesTemp[i]);
					selectedCircles.push(thisone);
					lineData.push({"x":data.Values[thisone].ImageDate, "y":data.Values[thisone][specIndex]});
				}
				
				$("#plotLine").remove();				//add the default line
				//make the line function to convert the xy object to svg path syntax 
				//var lineFunction = d3.svg.line() //TODO: CHECK IF THIS NEEDS TO BE A GLOBAL VARIABLE OR NOT
				//	.x(function(d){return xscale(d.x);})
				//	.y(function(d){return yscale(d.y);})
				//	.interpolate("linear");
				
				lineGraph = svg.append("path")
					.attr("d", lineFunction(lineData))
					.attr("id","plotLine")
					.attr("clip-path", "url(#clip)");
				
				//define the zooming function - what gets scaled on zoom 
				function zoomed() {
					svg.select(".y.axis").call(yaxis);
					svg.selectAll("circle").attr("cy", function(d){return yscale(d[specIndex]);});
					svg.selectAll("#plotLine").attr("d", lineFunction(lineData));
				}
				
				//define the zoom behavior
				var zoom = d3.behavior.zoom()
					.y(yscale)
					.scaleExtent([.1, 5])
					.on("zoom", zoomed);
				
				//call the function to make the scale change
				svg.call(zoom).on("dblclick.zoom", null);//svg was defined in the plotInt function
				updateSegmentForm();
				
			}
			
			//define function to return stretch color array by index
			function setcolor(data, specIndex, stretch, n_stdev, len) {
				var minv = stretch[specIndex].mean - (stretch[specIndex].stdev * n_stdev),
					maxv = stretch[specIndex].mean + (stretch[specIndex].stdev * n_stdev),
					color = [],
					i = 0;
				for (i; i < len; i++) {
					if (data.Values[i][specIndex] < minv) data.Values[i][specIndex] = minv;
					if (data.Values[i][specIndex] > maxv) data.Values[i][specIndex] = maxv;
					color[i] = ((data.Values[i][specIndex] - minv) / (maxv - minv)) * 256;
				}
				return color;
			}
			
			//define function to return scaled color arrays as RGB color
			function scaledRGB(data, RspecIndex, GspecIndex, BspecIndex, stretch, n_stdev, len){
				var colorR = setcolor(data, RspecIndex, stretch, n_stdev, len),
					colorG = setcolor(data, GspecIndex, stretch, n_stdev, len),
					colorB = setcolor(data, BspecIndex, stretch, n_stdev, len),
					color = [],
					i = 0;
				for(i;i<len;i++) {color[i] = d3.rgb(colorR[i],colorG[i],colorB[i]);}
				return color;
			}			
			
			//define function to calculate spectral indices from the raw band data
			function calcIndices(){
				//define and initialize variables		
				var b1 = 0, 
					b2 = 0, 
					b3 = 0,
					b4 = 0,
					b5 = 0,
					b7 = 0,
					bcoef = [0.2043, 0.4158, 0.5524, 0.5741, 0.3124, 0.2303],
					gcoef = [-0.1603, -0.2819, -0.4934, 0.7940, -0.0002, -0.1446],
					wcoef = [0.0315, 0.2021, 0.3102, 0.1594,-0.6806, -0.6109],
					i = 0;
				
				//calculate indices and include them in the json object
				for(i; i<len; i++){
					//pull out the values by band from json object so we don't have to deal with the long json text to 
					//call a value when calculating indices 
					b1 = data.Values[i].B1;
					b2 = data.Values[i].B2;
					b3 = data.Values[i].B3;
					b4 = data.Values[i].B4;
					b5 = data.Values[i].B5;
					b7 = data.Values[i].B7;
				
					//calculate indices
					data.Values[i]["TCB"]=(b1*bcoef[0])+(b2*bcoef[1])+(b3*bcoef[2])+(b4*bcoef[3])+(b5*bcoef[4])+(b7*bcoef[5]);		
					data.Values[i]["TCG"]=(b1*gcoef[0])+(b2*gcoef[1])+(b3*gcoef[2])+(b4*gcoef[3])+(b5*gcoef[4])+(b7*gcoef[5]);
					data.Values[i]["TCW"]=(b1*wcoef[0])+(b2*wcoef[1])+(b3*wcoef[2])+(b4*wcoef[3])+(b5*wcoef[4])+(b7*wcoef[5]);
					data.Values[i]["TCA"]=Math.atan(data.Values[i].TCG/data.Values[i].TCB) * (180/Math.PI) * 100;
					data.Values[i]["NBR"]=(b4-b7)/(b4+b7);
					data.Values[i]["NDVI"]=(b4-b3)/(b4+b3);
				}
			}
					
			//define function to initialize the spectral trajectory
			function plotInt(){
				//get the range of the x values
				var yearmin = d3.min(data.Values, function(d) {return d.ImageDate;}),
					yearmax = d3.max(data.Values, function(d) {return d.ImageDate;});
				
				//adjust the ranges so there is some buffer
				var xmin = yearmin-1, //
					xmax = yearmax+1;
				
				//define the width of the svg plot area
				var w = 740, 
					h = 250; 
				
				//define the plot margins
				var pt = 10, //plot top
					pr = 20, //plot right
					pl = 70, //plot left
					pb = 37; //plot bottom
				
				//define the x scale
				xscale = d3.scale.linear() //NEEDS TO BE A GLOBAL VARIABLE - IS USED HERE AND IN THE UPDATE FUNCTION
					.domain([xmin, xmax])
					.range([pl, w - pr]);
				
				//define the y scale
				yscale = d3.scale.linear() //NEEDS TO BE A GLOBAL VARIABLE - IS USED HERE AND IN THE UPDATE FUNCTION
					.domain([domain[specIndex].min, domain[specIndex].max])
					.range([h - pb, pt]);
						
				//define the x axis
				var xaxis = d3.svg.axis()
					.scale(xscale)
					.orient("bottom")
					.tickFormat(d3.format("d"));
				
				//define the x axis
				yaxis = d3.svg.axis() //NEEDS TO BE A GLOBAL VARIABLE - IS USED HERE AND IN THE UPDATE FUNCTION
					.scale(yscale)
					.orient("left");
				
				//define the zooming function - what gets scaled on zoom
				function zoomed() {
					svg.select(".y.axis").call(yaxis);
					svg.selectAll("circle").attr("cy", function(d){return yscale(d[specIndex]);});
					svg.selectAll("#plotLine").attr("d", lineFunction(lineData));
				}
				
				//define the zoom behavior
				var zoom = d3.behavior.zoom()
					.y(yscale)
					.scaleExtent([1, 5])
					.on("zoom", zoomed);
									
				svg = d3.select(svg); //retrieve the svg reference
				
				svg.call(zoom).on("dblclick.zoom", null); //call the zoom once - needed for the updating to work
						
				//make the default line data
				var lineData = [ //needs to be local variable
					{"x":yearmin ,"y":data.Values[0][specIndex]},
					{"x":yearmax ,"y":data.Values[len-1][specIndex]}
				];


				//make the line function to convert the xy object to svg path syntax 
				lineFunction = d3.svg.line() //global because it gets used when selecting new points
					.x(function(d){return xscale(d.x);})
					.y(function(d){return yscale(d.y);})
					.interpolate("linear");
				
				//create the circles that will go into the svg
				var circles = svg.selectAll("circle")
					.data(data.Values)
					.enter()
					.append("circle")
					.style("fill",function(d,i){return rgbColor[i]})
					.attr("cx", function(d){return xscale(d.ImageDate);})
					.attr("cy", function(d){return yscale(d[specIndex]);})
					.attr("r", 9)
					.attr("class","unselected");
				
				//add the default line
				var lineGraph = svg.append("path") //local because it will get overwritten
					.attr("d", lineFunction(lineData))
					.attr("id","plotLine");
				
				//draw the x axis
				svg.append("g")
					.attr("class", "x axis")
					.attr("transform", "translate(0," + (h - pb) + ")")
					.call(xaxis);
					
				//draw the y axis
				svg.append("g")
					.attr("class", "y axis")
					.attr("transform", "translate(" + pl + ",0)")
					.call(yaxis);
					
				//add label for the x axis
				svg.append("text")      
					.attr("transform", "rotate(-90)")
					.attr("x", (h-pb)/-2)
					.attr("y", 20)
					.style("text-anchor", "middle")
					.text("TC Wetness")
					.attr("id","specPlotIndex");
				
				//define clip path so that circles don't go outside the axes
				svg.append("defs")
					.append("clipPath")
					  .attr("id", "clip")
					.append("rect")
					  .attr("x", 50)
					  .attr("y", 10)
					  .attr("width", w-pr)
					  .attr("height", h-pb-pt);
				
				//add the path to the circles to activate the clipping
				circles.attr("clip-path", "url(#clip)");
				lineGraph.attr("clip-path", "url(#clip)");
				
				//default the first and last circles to class "selected"
				$("circle").eq(0).attr("class","selected");
				$("circle").eq(len-1).attr("class","selected");
				//var vertices = $("circle.selected");
				
				//fill in the global selectedCircles variable for the first time
				var selectedCirclesTemp = $("circle.selected"),
					i = 0;
				for(i; i < selectedCirclesTemp.length; i++){
					selectedCircles.push($("circle").index(selectedCirclesTemp[i]));
				}
				updateSegmentForm();
			}
			

			
			

			
			
			
			
			//define function to update the D3 scatterplot when new selection are made
			function update(data, specIndex, rgbColor, domain){
				//update the y domain based on the new index
				yscale.domain([domain[specIndex].min, domain[specIndex].max]); //yscale was defined in the plotInt function
				
				//define the zooming function - what gets scaled on zoom 
				function zoomed() {
					svg.select(".y.axis").call(yaxis);
					svg.selectAll("circle").attr("cy", function(d){return yscale(d[specIndex]);});
					svg.selectAll("#plotLine").attr("d", lineFunction(lineData));
				}
				
				//define the zoom behavior
				var zoom = d3.behavior.zoom()
					.y(yscale)
					.scaleExtent([1, 5])
					.on("zoom", zoomed);
				
				//call the function to make the scale change
				svg.call(zoom).on("dblclick.zoom", null)//svg was defined in the plotInt function
				
				//update the circles with new data
				svg.selectAll("circle") //svg was defined in the plotInt function
					.data(data.Values)					   
					.transition()
					.duration(500)
					.attr("cx", function(d){return xscale(d.ImageDate);})
					.attr("cy", function(d){return yscale(d[specIndex]);})
					.style("fill",function(d,i){return rgbColor[i]})

					
				/////////////////////////////////LINE UPDATE////////////////////////////////	
				//retrieve the line data (this section could be made into a function cause it is also used in the changePlotLine function)
				//selectedCircles = $("circle.selected");
				var lineData = [];
				var i = 0;
				for(i; i < selectedCircles.length; i++){
					//var thisone = $("circle").index(selectedCircles[i]);
					var thisone = selectedCircles[i];
					lineData.push({"x":data.Values[thisone].ImageDate, "y":data.Values[thisone][specIndex]});
				}
				
				//update the line
				svg.selectAll("#plotLine") //local because it will get overwritten
					.transition()
					.duration(500)
					.attr("d", lineFunction(lineData));

				/////////////////////////////////////////////////////////////////////////////
					
				//update y axis
				svg.select(".y.axis") //svg was defined in the plotInt function
					.transition()
					.duration(500)
					.call(yaxis);
			}
			
			
			//update the plot when buttons are clicked		
			//right now the points and colors are redrawn each time, in the future could break this down
			//by which button type is pressed, either index or color and only update either the point locations
			//or the colors
			$(document).ready(function(){
				$(".dropdown-menu li").click(function() { //This will attach the function to all the input elements
					
					//figure out which dropdown was selected and change its active status 
					var thisListID = $(this).closest("ul").attr('id'),
						thisSpecIndexID = $(this).attr('id'),
						newactive = "#"+thisListID+" #"+thisSpecIndexID,
						activesearch = "#"+thisListID+" .active",
						activeid = $(activesearch).attr('id'),
						oldactive = "#"+thisListID+" #"+activeid;
					
					$(oldactive).removeClass('active');
					$(newactive).addClass('active');
					
					if(thisListID == "index-list"){$("#btnIndex div").replaceWith('<div><strong>Index:</strong><br><small>'+$("#"+thisSpecIndexID).text()+'</small><span class="caret"></span></div>')};
					if(thisListID == "red-list"){$("#btnRed div").replaceWith('<div><strong>R</strong><small>GB</small><br><small>'+$("#"+thisSpecIndexID).text()+'</small><span class="caret"></span></div>')};
					if(thisListID == "green-list"){$("#btnGreen div").replaceWith('<div><small>R</small><strong>G</strong><small>B</small><br><small>'+$("#"+thisSpecIndexID).text()+'</small><span class="caret"></span></div>')};
					if(thisListID == "blue-list"){$("#btnBlue div").replaceWith('<div><small>RG</small><strong>B</strong><br><small>'+$("#"+thisSpecIndexID).text()+'</small><span class="caret"></span></div>')};
					
					
					
					//get the active classes from the dropdown displays buttons
					var activeSpecIndex = $("#index-list li.active").attr('id'),		
						activeRedSpecIndex = $("#red-list li.active").attr('id'),
						activeGreenSpecIndex = $("#green-list li.active").attr('id'),
						activeBlueSpecIndex = $("#blue-list li.active").attr('id');
					
					//get the RBG color
					rgbColor = scaledRGB(data, activeRedSpecIndex, activeGreenSpecIndex, activeBlueSpecIndex, stretch, 2, len);
					
					//reset the global varible so that other functions know what it is know
					specIndex=activeSpecIndex 
					
					//update the plot
					update(data, specIndex, rgbColor, domain);
					$("#specPlotIndex").text($("#"+specIndex).text());
				});
			});
			
			
			//mechanism to display the selected points and line in the trajectory plot
			$("#btnLine").click(function(){
				if ($("#lineDisplayThumb").attr("class") == "glyphicon glyphicon-thumbs-up"){
					$("#lineDisplayThumb").removeClass("glyphicon glyphicon-thumbs-up")
						.addClass("glyphicon glyphicon-thumbs-down");
					$("circle.selected").css("stroke-width","0");
					$("#plotLine").css("stroke-width","0");
				} else{
					$("#lineDisplayThumb").removeClass("glyphicon glyphicon-thumbs-down")
						.addClass("glyphicon glyphicon-thumbs-up");
					$("circle.selected").css("stroke-width","1");
					$("#plotLine").css("stroke-width","2");
				}
			});


			
			
			
///////////////////////////////////////////////////////BELOW ARE LINE INFO FORM SCRIPTS/////////////////////////////////////////////////////////////////
//////////////BELOW ARE LINE INFO FORM SCRIPTS////////////////////////////////////////BELOW ARE LINE INFO FORM SCRIPTS//////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////BELOW ARE LINE INFO FORM SCRIPTS////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////BELOW ARE LINE INFO FORM SCRIPTS/////////////////////////////////
////////////////////////////BELOW ARE LINE INFO FORM SCRIPTS////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////BELOW ARE LINE INFO FORM SCRIPTS/////////////////////////////////BELOW ARE LINE INFO FORM SCRIPTS////			



////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////
//GLOBAL VARIABLES//////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////

//template lineInfo object which holds all the segment and vertice info
//			var lineInfo = {
//					vertices:[{
//						year:0,
//						index:0,
//						landUse:{
//							dominant:"",
//							notes:{
//								wetland:null,
//								mining:null,
//								rowCrop:null,
//								orchardTreeFarm:null,
//								vineyardsOtherWoody:null
//							}
//						},
//						landCover:{
//							dominant:"",
//							other:{
//								trees:null,
//								shrubs:null,
//								grassForbHerb:null,
//								impervious:null,
//								naturalBarren:null,
//								SnowIce:null,
//								water:null
//							}
//						},
//						changeProcess:{
//							changeProcess:"",
//							notes:{
//								natural:null,
//								prescribed:null,
//								sitePrepFire:null,
//								airphotoOnly:null,
//								clearcut:null,
//								thinning:null,
//								flooding:null,
//								reserviorLakeFlux:null,
//								wetlandDrainage:null
//							}
//						}
//					}],
//					segments:[{
//						startYear:1984,
//						endYear:2014,
//						startIndex:0,
//						endIndex:0,
//					}]
//				};
			
		    var lineInfo = {vertices:[],segments:[]}


////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////
//EVENT LISTENERS///////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////
					
			//controls the trajectory form section tabs and tables 
			$("#segmentsFormTab").click(function(){	
				var status = $("#segmentsFormTab").attr("class");
				if(status == "unselected"){
					circleHighlightOff();
					closeDropAndRecord();
					$("#segmentsFormTab").attr("class","selected");
					$("#verticesFormTab").attr("class","unselected");
					$("#segmentsFormDiv").show();
					$("#verticesFormDiv").hide();
				}
			});
			$("#verticesFormTab").click(function(){				
				var status = $("#verticesFormTab").attr("class");
				if(status == "unselected"){
					circleHighlightOff();
					closeDropAndRecord();
					$("#verticesFormTab").attr("class","selected");
					$("#segmentsFormTab").attr("class","unselected");
					$("#verticesFormDiv").show();
					$("#segmentsFormDiv").hide();
				}
			});
			

//INPUT DROP DOWNS AND HIGHLIGHTING CIRCLES PERTAINING TO THE SELECTED ROW//////////////////////
			//change process
			$(document).ready(function(){
				$(document).on("click",".changeProcessInput",function(e){ //listen for a click on a changeProcessInput <li>					
					//$(".changeProcessInput.active").removeClass("active"); //clear any .changeProcessInput "active" classes so that this will be the only one
					closeDropAndRecord();
					var thisInput = $(this); //store the reference to element as a variable, so we don't have to keep making jquery reference - gets used a lot
					//$("tr.segment.active").removeClass("active"); //make sure there are no active rows for changeProcessInput
					//$("circle.highlight").attr("class","selected"); //make sure there are no highlighed circles - MIGHT NOT NEED THIS???
					
					
					thisInput.addClass("active"); //set this .changeProcessInput <td> as the "active" class so that when a selection is made from the #changeProcessList dropdown it knows which <td> to place it in
					dropInputLists(thisInput, "changeProcessDiv", -1, -1, 1);
					thisInput.closest("tr").addClass("active");					
					
					//fill in info from table for this segment
					var thisOne = $("tr.segment .changeProcessInput").index(thisInput)+1, //find what change process row was selected
						selection = lineInfo.vertices[thisOne].changeProcess.changeProcess
					
					//fill in the forms with info from the table - will be blank at first but will reflect the input information if the change process input is clicked on again					
					appendCPnotes(selection);					
					changeNoteIcon("#CPnotesList", thisOne, "changeProcess");
					
					//point highlighting
					var startIndex = lineInfo.segments[thisOne-1].startIndex; //pull out the start index for the selected row
					var endIndex = lineInfo.segments[thisOne-1].endIndex; //pull out the end index for the selected row
					$("circle:eq("+startIndex+")").attr("class","highlight"); //highlight the start circle for the selected row (segment)
					$("circle:eq("+endIndex+")").attr("class","highlight"); //highlight the end circle for the selected row (segment)
					$("canvas:eq("+startIndex+")").attr("class","highlight"); //highlight the start canvas for the selected row (segment)
					$("canvas:eq("+endIndex+")").attr("class","highlight"); //highlight the end canvas for the selected row (segment)
					$("circle").css("cursor","not-allowed");
					$("canvas").css("cursor","not-allowed");

					e.stopPropagation();
                });
            });			
			
			//land use
			$(document).ready(function(){
				$(document).on("click",".landUseInput",function(e){ //listen for a click on a changeProcessInput <li>					
					//$(".landUseInput.active").removeClass("active"); //clear any .changeProcessInput "active" classes so that this will be the only one
					closeDropAndRecord();
					var thisInput = $(this);
					//$("tr.vertex.active").removeClass("active"); //make sure there are no active rows for changeProcessInput
					//$("circle.highlight").attr("class","selected"); //make sure there are no highlighed circles - MIGHT NOT NEED THIS???
					
					thisInput.addClass("active"); //set this .landUseInput <td> as the "active" class so that when a selection is made from the #changeProcessList dropdown it knows which <td> to place it in
					dropInputLists(thisInput, "landUseDiv", -1, -1, 1); //show the dropdown				
					thisInput.closest("tr").addClass("active");
					
					//point highlighting
					var thisOne = $("tr.vertex .landUseInput").index(thisInput);
					var selection = lineInfo.vertices[thisOne].landUse.dominant;
					//$("#landUseSelection").text(selection);
					
					//fill in the forms with info from the table - will be blank at first but will reflect the input information if the change process input is clicked on again					
					appendLUnotes(selection);					
					changeNoteIcon("#LUnotesList", thisOne, "landUse");
					
					//point highlighting
					var thisIndex = lineInfo.vertices[thisOne].index;
					$("circle:eq("+thisIndex+")").attr("class","highlight");
					$("canvas:eq("+thisIndex+")").attr("class","highlight");
					$("circle").css("cursor","not-allowed");
					$("canvas").css("cursor","not-allowed");

					e.stopPropagation();
                });
            });

			//land cover
			$(document).ready(function(){
				$(document).on("click",".landCoverInput",function(e){ //listen for a click on a changeProcessInput <li>					
					//$(".landCoverInput.active").removeClass("active"); //clear any .changeProcessInput "active" classes so that this will be the only one
					closeDropAndRecord();
					var thisInput = $(this);
					//$("tr.vertex.active").removeClass("active"); //make sure there are no active rows for changeProcessInput
					//$("circle.highlight").attr("class","selected"); //make sure there are no highlighed circles - MIGHT NOT NEED THIS???
					
					thisInput.addClass("active"); //set this .landCoverInput <td> as the "active" class so that when a selection is made from the #changeProcessList dropdown it knows which <td> to place it in
					dropInputLists(thisInput, "landCoverDiv", -1, -1, 1); //show the dropdown				
					thisInput.closest("tr").addClass("active");
					
					//point highlighting
					var thisOne = $("tr.vertex .landCoverInput").index(thisInput),
						selection = lineInfo.vertices[thisOne].landCover.dominant;
									
					//change the note icon depending on whether the note is selected or not
					theseLi = $("#LCnotesList li")
					theseLi.each(function(i){
						var thisLi = $(this),
							note = thisLi.attr("class"),
							span = thisLi.children("span");
							noteNull = lineInfo.vertices[thisOne].landCover.other[note];		
						if(noteNull == null){
							span.replaceWith('<span class="glyphicon glyphicon-unchecked"></span> ')
						} else{
							span.replaceWith('<span class="glyphicon glyphicon-ok"></span> ');
							thisLi.addClass("selected");
						}
					});
				
					//point highlighting
					var thisIndex = lineInfo.vertices[thisOne].index;
					$("circle:eq("+thisIndex+")").attr("class","highlight");
					$("canvas:eq("+thisIndex+")").attr("class","highlight");
					$("circle").css("cursor","not-allowed");
					$("canvas").css("cursor","not-allowed");

					e.stopPropagation();
                });
            });				
///////////////////////////////////////////////////////////////////////////////////////////////////

//DROP THE SELECTION LISTS ON CLICK///////////////////////////////////////////////////////////////////
			//change process
			$("#changeProcessSelection").click(function(e){			
				$("#changeProcessList").show();
				e.stopPropagation();
			});
			
			//land use
			$("#landUseSelection").click(function(e){			
				$("#landUseList").show();
				e.stopPropagation();
			});
			
			//land cover
			$("#landCoverSelection").click(function(e){			
				$("#landCoverList").show();
				e.stopPropagation();
			});
////////////////////////////////////////////////////////////////////////////////////////////////////////
			
						
//DONE BUTTON EVENT HANDLERS////////////////////////////////////////////////////////////////////////////
			//when done buttons are clicked close their dropdown and record  the info in the inputs to the lineInfo object
			$(".doneBtn").click(function(){
				closeDropAndRecord();
			});



//////////////////////////////////////////////////////////////////////////////////////////////////////////
			
			
//DISPLAY THE CONDITIONAL NOTES ONCE A CHANGE PROCESS HAS BEEN SELECTED/////////////////
			//change process
			$(document).ready(function(){
				$("#changeProcessList li").click(function(){ //click anywhere to get rid of the .dropThis dropdowns
						var selection = $(this).text();
						$("#changeProcessList").hide();
						$("td.changeProcessInput.active").text(selection); //,#changeProcessSelection, 				
						appendCPnotes(selection);
						$("#CPnotesList li").prepend('<span class="glyphicon glyphicon-unchecked"></span> ');			
				});
			});
			
			//land use
			$(document).ready(function(){
				$("#landUseList li").click(function(){
						var selection = $(this).text();
						$("#landUseList").hide();
						$("td.landUseInput.active").text(selection); //,#landUseSelection, 					
						appendLUnotes(selection);
						$("#LUnotesList li").prepend('<span class="glyphicon glyphicon-unchecked"></span> ');			
				});
			});
			
			//land cover
			$(document).ready(function(){
				$("#landCoverList li").click(function(){
						var selection = $(this).text();
						$("#landCoverList").hide();
						$("td.landCoverInput.active").text(selection); //,#landCoverSelection,				
				});
			});
/////////////////////////////////////////////////////////////////////////////////////////
			
			
//MAKE THE NOTE CHECKBOXES TOGGLE ON AND OFF AND SET THE "SELECTED" CLASS////////////////
			//#CPnotesList li SELECTION AND CHECKBOXES
			$(document).ready(function(){
				$(document).on("click","#CPnotesList li", function(){
					var selected = $(this);
					if(selected.hasClass("selected")){
						selected.removeClass("selected");
						$("span", this).replaceWith('<span class="glyphicon glyphicon-unchecked"></span> ');
					} else {
						selected.addClass("selected");
						$("span", this).replaceWith('<span class="glyphicon glyphicon-ok"></span> ');
					}
				});
			});
			
			//#LUnotesList li SELECTION AND CHECKBOXES
			$(document).ready(function(){
				$(document).on("click","#LUnotesList li", function(){
					var selected = $(this);
					if(selected.hasClass("selected")){
						selected.removeClass("selected");
						$("span", this).replaceWith('<span class="glyphicon glyphicon-unchecked"></span> ');
					} else {
						selected.addClass("selected");
						$("span", this).replaceWith('<span class="glyphicon glyphicon-ok"></span> ');
					}
				});
			});
			
			//#LCnotesList li SELECTION AND CHECKBOXES
			$(document).ready(function(){
				$(document).on("click","#LCnotesList li", function(){
					var selected = $(this);
					if(selected.hasClass("selected")){
						selected.removeClass("selected");
						$("span", this).replaceWith('<span class="glyphicon glyphicon-unchecked"></span> ');
					} else {
						selected.addClass("selected");
						$("span", this).replaceWith('<span class="glyphicon glyphicon-ok"></span> ');
					}
				});
			});
//////////////////////////////////////////////////////////////////////////////////////////

			//highlight selected circles, canvases, and input row when the magnifying glass is clicked
			$(document).ready(function(){
				$(document).on("click","td.highlightIt", function(){
					var thisTr = $(this).closest("tr");
					if(thisTr.hasClass("active")){
						circleHighlightOff();
						closeDropAndRecord();						
					} else {
						circleHighlightOff();
						closeDropAndRecord();
						if(thisTr.hasClass("segment")){
							thisTr.addClass("active");
							thisOne = $("tr.segment").index(thisTr);
							
//TODO						//THESE LINES TO TURN ON CIRCLE AND CANVAS HIGHLIGHTING ARE REPEATED - MAKE INTO A FUNCTION
							var startIndex = lineInfo.segments[thisOne].startIndex;
							var endIndex = lineInfo.segments[thisOne].endIndex;
							$("circle:eq("+startIndex+")").attr("class","highlight");
							$("circle:eq("+endIndex+")").attr("class","highlight");
							$("canvas:eq("+startIndex+")").attr("class","highlight");
							$("canvas:eq("+endIndex+")").attr("class","highlight");
							$("circle").css("cursor","not-allowed");
							$("canvas").css("cursor","not-allowed");
						} else {
							thisTr.addClass("active");
							thisOne = $("tr.vertex").index(thisTr);
							var thisIndex = lineInfo.vertices[thisOne].index;
							$("circle:eq("+thisIndex+")").attr("class","highlight");
							$("canvas:eq("+thisIndex+")").attr("class","highlight");
							$("circle").css("cursor","not-allowed");
							$("canvas").css("cursor","not-allowed");
						}
					}
				});
			});

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
//UNIQUE FUNCTIONS//////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

//APPEND NOTES TO THE NOTES DIV///////////////////////////////////////////////////////////////////	
			//change process
			function appendCPnotes(selection){					
				$("#CPnotesList").empty();
				switch(selection){
					case "Fire":
						$("#CPnotesList").append('<li class="natural">Natural</li><li class="prescribed">Prescribed</li><li class="sitePrepFire">Site-prep fire</li><li class="airphotoOnly">Airphoto only</li>');								
						break;
					case "Harvest":
						$("#CPnotesList").append('<li class="clearcut">Clearcut</li><li class="thinning">Thinning</li><li class="sitePrepFire">Site-prep fire</li><li class="airphotoOnly">Airphoto only</li>');								
						break;
					case "Decline":
						$("#CPnotesList").append('<li class="airphotoOnly">Airphoto only</li>');								
						break;
					case "Wind":
						$("#CPnotesList").append('<li class="airphotoOnly">Airphoto only</li>');								
						break;
					case "Hydrology":
						$("#CPnotesList").append('<li class="flooding">Flooding</li><li class="reserviorLakeFlux">Reservoir/Lake flux</li><li class="airphotoOnly">Airphoto only</li>');								
						break;
					case "Debris":
						$("#CPnotesList").append('<li class="airphotoOnly">Airphoto only</li>');								
						break;
					case "Growth":
						$("#CPnotesList").append('<li class="airphotoOnly">Airphoto only</li>');								
						break;
					case "Stable":
						$("#CPnotesList").append('<li class="airphotoOnly">Airphoto only</li>');								
						break;
					case "Conversion":
						$("#CPnotesList").append('<li class="wetlandDrainage">Wetland drainage</li><li class="airphotoOnly">Airphoto only</li>');
						break;
					case "Other":
						$("#CPnotesList").append('<li class="airphotoOnly">Airphoto only</li>');
						break;						
				}
			}
			
			//land use
			function appendLUnotes(selection){					
				$("#LUnotesList").empty();
				switch(selection){
					case "Forest":
						$("#LUnotesList").append('<li class="wetland">Wetland</li>');								
						break;
					case "Developed":
						$("#LUnotesList").append('<li class="mining">Mining</li>');								
						break;
					case "Agriculture":
						$("#LUnotesList").append('<li class="rowCrop">Row crop</li><li class="orchardTreeFarm">Orchard/Tree farm</li><li class="vineyardsOtherWoody">Vineyard/Other woody</li>');								
						break;						
				}
			}
			
			
//DONE BUTTON FUNCTION TO CLOSE DROPDOWN MENUS AND RECORD INFO FROM THE FORM INPUTS TO THE LINEINFO OBJECT						
			function changeProcessDoneBtn(){
				$("#changeProcessDiv").hide();
				$("#changeProcessList").hide();
				
				//remove the highlighted circle class - could find the highlighted class and only change that one (current implementation) or just reset all selected circles (commented out)
				circleHighlightOff();
				
				//fill in the lineInfo object
				var thisOne = $(".changeProcessInput").index($(".changeProcessInput.active"))+1;
				var selection = $("td.changeProcessInput.active").text();
				
				
				lineInfo.vertices[thisOne].changeProcess.changeProcess = selection;		
				switch(selection){
					case "Fire":
						fillInNotes("#CPnotesList .selected",thisOne,"natural","changeProcess");
						fillInNotes("#CPnotesList .selected",thisOne,"prescribed","changeProcess");
						fillInNotes("#CPnotesList .selected",thisOne,"sitePrepFire","changeProcess");
					break;
					case "Harvest":
						fillInNotes("#CPnotesList .selected",thisOne,"clearcut","changeProcess");
						fillInNotes("#CPnotesList .selected",thisOne,"thinning","changeProcess");
						fillInNotes("#CPnotesList .selected",thisOne,"sitePrepFire","changeProcess");						
					break;
					case "Decline":								
					break;
					case "Wind":								
					break;
					case "Hydrology":
						fillInNotes("#CPnotesList .selected",thisOne,"flooding","changeProcess");
						fillInNotes("#CPnotesList .selected",thisOne,"reserviorLakeFlux","changeProcess");											
					break;
					case "Debris":								
					break;
					case "Growth":							
					break;
					case "Stable":							
					break;
					case "Conversion":
						fillInNotes("#CPnotesList .selected",thisOne,"wetlandDrainage","changeProcess");						
					break;
					case "Other":
					break;						
				}
				fillInNotes("#CPnotesList .selected",thisOne,"airphotoOnly","changeProcess");
			}
			
			//land use
			function landUseDoneBtn(){				
				$("#landUseDiv").hide(); //hide the dropdown
				$("#landUseList").hide();
				
				//remove the highlighted circle class - could find the highlighted class and only change that one (current implementation) or just reset all selected circles (commented out)				
				circleHighlightOff();
				
				//fill in the lineInfo object
				var thisOne = $(".landUseInput").index($(".landUseInput.active"));
				var selection = $("td.landUseInput.active").text();
				
				lineInfo.vertices[thisOne].landUse.dominant = selection;			
				switch(selection){
					case "Forest":
						fillInNotes("#LUnotesList .selected",thisOne,"wetland","landUse");
					break;
					case "Developed":
						fillInNotes("#LUnotesList .selected",thisOne,"mining","landUse");
					
					break;
					case "Agriculture":								
						fillInNotes("#LUnotesList .selected",thisOne,"rowCrop","landUse");
						fillInNotes("#LUnotesList .selected",thisOne,"orchardTreeFarm","landUse");
						fillInNotes("#LUnotesList .selected",thisOne,"vineyardsOtherWoody","landUse");
					break;					
				}		
			}
	
			//land cover
			function landCoverDoneBtn(){			
				$("#landCoverDiv").hide(); //hide the dropdown
				$("#landCoverList").hide();
				
				//remove the highlighted circle class - could find the highlighted class and only change that one (current implementation) or just reset all selected circles (commented out)				
				circleHighlightOff();
			
				//fill in the lineInfo object
				var thisOne = $(".landCoverInput").index($(".landCoverInput.active"));
				var selection = $("td.landCoverInput.active").text();
				
				lineInfo.vertices[thisOne].landCover.dominant = selection;			
				
				fillInNotes("#LCnotesList .selected",thisOne,"trees","landCover");
				fillInNotes("#LCnotesList .selected",thisOne,"shrubs","landCover");
				fillInNotes("#LCnotesList .selected",thisOne,"grassForbHerb","landCover");
				fillInNotes("#LCnotesList .selected",thisOne,"impervious","landCover");
				fillInNotes("#LCnotesList .selected",thisOne,"naturalBarren","landCover");
				fillInNotes("#LCnotesList .selected",thisOne,"SnowIce","landCover");
				fillInNotes("#LCnotesList .selected",thisOne,"water","landCover");
				$("#LCnotesList .selected").removeClass("selected");		
			}				
						
////////////////////////////////////////////////////////////////////////////////////////////////////////



////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
//SHARED FUNCTIONS//////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
			//function to sync the segments form to the selected vertices
			function updateSegmentForm(){
				$(".segment").remove();
				$(".vertex").remove();
				lineInfo = {vertices:[],segments:[]}
				var yearStart = 0,
					yearEnd = 0,
					len = selectedCircles.length,
					startIndex = 0,
					endIndex = 0,
					i = 0;
				
				//make empty segment entries
				for(i; i < len-1; i++){
					startIndex = selectedCircles[i];
					endIndex = selectedCircles[i+1];
					yearStart = years[startIndex];
					yearEnd =   years[endIndex];
					$("#segmentsFormTbl").append('<tr class="segment"><td class="highlightIt"><span class="glyphicon glyphicon-search"></span></td><td>'+yearStart+'</td><td>'+yearEnd+'</td><td class="changeProcessInput formDrop"></td></tr>');
					lineInfo.segments.push({
						startYear:yearStart,endYear:yearEnd,startIndex:startIndex,endIndex:endIndex,changeProcess:"",
						notes:{
							natural:null,
							prescribed:null,
							sitePrepFire:null,
							airphotoOnly:null,
							clearcut:null,
							thinning:null,
							flooding:null,
							reserviorLakeFlux:null,
							wetlandDrainage:null
						}
					});
				}
				
				//make empty vertex entries
				for(i=0; i < len; i++){
					startIndex = selectedCircles[i];
					yearStart = years[startIndex];
					$("#verticesFormTbl").append('<tr class="vertex"><td class="highlightIt"><span class="glyphicon glyphicon-search"></span></td><td>'+yearStart+'</td><td class="landUseInput formDrop"></td><td class="landCoverInput formDrop"></td></tr>');
					lineInfo.vertices.push({
						year:yearStart,index:startIndex,
						landUse:{
							dominant:"",
							notes:{
								wetland:null,
								mining:null,
								rowCrop:null,
								orchardTreeFarm:null,
								vineyardsOtherWoody:null
							}
						
						},
						landCover:{
							dominant:"",
							other:{
								trees:null,
								shrubs:null,
								grassForbHerb:null,
								impervious:null,
								naturalBarren:null,
								SnowIce:null,
								water:null
							}
						},
						changeProcess:{
							changeProcess:"",
							notes:{
								natural:null,
								prescribed:null,
								sitePrepFire:null,
								airphotoOnly:null,
								clearcut:null,
								thinning:null,
								flooding:null,
								reserviorLakeFlux:null,
								wetlandDrainage:null
							}
						}
					});
				}
			}	
			
			
			//function to show a dropdown for the land use and change process inputs
			function dropInputLists(thisInput, thisList, xAdj, yAdj, widthAdj){
				var rowPos = thisInput.position(),
					bottomTop = rowPos.top,
					bottomLeft = rowPos.left,
					bottomWidth = thisInput[0].getBoundingClientRect().width,
					bottomHeight = thisInput[0].getBoundingClientRect().height
					
				//drop its dropdown based on the position of the clicked element
				$("#"+thisList).css({
					position: "absolute",
					top: (bottomTop+parseFloat(bottomHeight)+yAdj),
					left: bottomLeft+xAdj,
					width: (parseFloat(bottomWidth)+widthAdj+"px")
				}).show();
			}
			
			//fill in note check box status in the lineInfo object when the done button is pressed
			function fillInNotes(selector, thisOne, noteClass, inputType){
				noteClassSelected = $(selector).hasClass(noteClass);
				switch(inputType){
					case "landUse":
						if(noteClassSelected){
							lineInfo.vertices[thisOne].landUse.notes[noteClass] = true;
						} else {
							lineInfo.vertices[thisOne].landUse.notes[noteClass] = null;
						}	
					break;
					case "landCover":
						if(noteClassSelected){
							lineInfo.vertices[thisOne].landCover.other[noteClass] = true;
						} else {
							lineInfo.vertices[thisOne].landCover.other[noteClass] = null;
						}						
					break;
					case "changeProcess":
						if(noteClassSelected){
							lineInfo.vertices[thisOne].changeProcess.notes[noteClass] = true;
						} else {
							lineInfo.vertices[thisOne].changeProcess.notes[noteClass] = null;
						}
					break;
				}
			}
			
			//function to change the note icon depending on whether the note is selected or not
			function changeNoteIcon(notesList, thisOne, inputType){
				theseLi = $(notesList+" li")
				theseLi.each(function(i){
					var thisLi = $(this)
					var noteClass = thisLi.attr("class");
					
					switch(inputType){
						case "landUse":
							noteNull = lineInfo.vertices[thisOne].landUse.notes[noteClass];
						break;
						case "landCover":
							noteNull = lineInfo.vertices[thisOne].landCover.other[noteClass];
						break;
						case "changeProcess":
							noteNull = lineInfo.vertices[thisOne].changeProcess.notes[noteClass];
						break;
					}
					
					//noteNull = lineInfo.segments[thisOne].notes[noteClass];
					if(noteNull == null){
						thisLi.prepend('<span class="glyphicon glyphicon-unchecked"></span> ') //theseLi.eq(i)
					} else{
						thisLi.prepend('<span class="glyphicon glyphicon-ok"></span> '); //theseLi.eq(i)
						thisLi.addClass("selected");
					}
				});
			}
			
			//turn circle highlighting off
			function circleHighlightOff(linePart){
				//linePart eq vertex | segment
				$("circle.highlight").attr("class","selected");
				$("canvas.highlight").attr("class","selected");				
				//$("tr."+linePart+".active").removeClass("active"); //remove the land use row from the active class			
				$("tr.active").removeClass("active"); //remove the land use row from the active class			
				$("circle").css("cursor","pointer");
				$("canvas").css("cursor","pointer");
			}
			
			//figure out which dropdown to close and what info to record
			function closeDropAndRecord(){
				var tdActive = $("td.active");
				if(tdActive.hasClass("changeProcessInput")){
					console.log("im in changeProcessInput!");
					changeProcessDoneBtn();	
				} else if(tdActive.hasClass("landUseInput")){
					console.log("im in landUseInput!");
					landUseDoneBtn();
				} else if(tdActive.hasClass("landCoverInput")){
					console.log("im in landCoverInput!");
					landCoverDoneBtn();	
				}
				tdActive.removeClass("active");
			}
/////////////////////////////////////////////////////////////////////////////////////////
			
			
			
			
			
///////////////////////////////////////////////////////BELOW ARE CHIP SCRIPTS///////////////////////////////////////////////////////
//////////////BELOW ARE CHIP SCRIPTS////////////////////////////////////////BELOW ARE CHIP SCRIPTS//////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////BELOW ARE CHIP SCRIPTS//////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////BELOW ARE CHIP SCRIPTS///////////////////////
////////////////////////////BELOW ARE CHIP SCRIPTS//////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////BELOW ARE CHIP SCRIPTS/////////////////////////////////BELOW ARE CHIP SCRIPTS////
		
			///////////////SET GLOBAL VARIABLES//////////////////////////////////////////////////////////
			
			var images = [
				"chips/test_chip_1985.png",
				"chips/test_chip_1986.png",
				"chips/test_chip_1987.png",
				"chips/test_chip_1988.png",
				"chips/test_chip_1989.png",
				"chips/test_chip_1990.png",
				"chips/test_chip_1991.png",
				"chips/test_chip_1992.png",
				"chips/test_chip_1993.png",
				"chips/test_chip_1994.png",
				"chips/test_chip_1995.png",
				"chips/test_chip_1996.png",
				"chips/test_chip_1997.png",
				"chips/test_chip_1998.png",
				"chips/test_chip_1999.png",
				"chips/test_chip_2000.png",
				"chips/test_chip_2001.png",
				"chips/test_chip_2002.png",
				"chips/test_chip_2003.png",
				"chips/test_chip_2004.png",
				"chips/test_chip_2005.png",
				"chips/test_chip_2006.png",
				"chips/test_chip_2007.png",
				"chips/test_chip_2008.png",
				"chips/test_chip_2009.png",
				"chips/test_chip_2010.png",
				"chips/test_chip_2011.png",
				"chips/test_chip_2012.png",
				"chips/test_chip_2013.png",
				"chips/test_chip_2014.png"
			];
			years = [];
			for(var i=0;i<images.length;i++){years.push(1985+i)}
			
			var chipInfo = {
					box: 1,
					boxZoom: 1,
					chipSize:195,
					halfChipSize:97.5,
					offset:30,
					canvasHeight:212,
					dateYpos:207,
					dateXpos:76.05,
					zoomLevel:20, //0
					chips:{
						useThisChip:[],
						canvasIDs:[],
						imgIDs:[],
						sxOrig:[],
						syOrig:[],
						sWidthOrig:[],
						sxZoom:[],
						syZoom:[],
						sWidthZoom:[],
						chipsInStrip:[]
					}
				};
			
			var n_chips = images.length,
				minZoom = 0,
				maxZoom = 40,
				stopZoom = 40,
				sAdj = [0],
				lwAdj = [chipInfo.box],
				zoomIn = 0;
			
			
			$("#plotSize").click(function(e){
				var boxSize = $("#plotSize").text()
				var thisInput = $("#plotSize"); 
				dropInputLists(thisInput, "plotSizeList", 0, -1, 0);
				e.stopPropagation();
			});
			$("#plotSizeList li").click(function(){
				plotSize = $(this).text();
				$("#plotSize").text(plotSize)
				chipInfo.box = Math.sqrt(plotSize);
				$("#plotSizeList").hide();
				switch(chipInfo.box){
					case 1:
						stopZoom = 40;
						break;
					case 3:
						stopZoom = 32;
						break;
					case 5:
						stopZoom = 27;
						break;
				}
				updateChipInfo();
				drawAllChips();
			});
			
			///////////CHIP SIZE CHANGE///////////////////////////////////////////////////////////////////////////////
			$("#chipSize").click(function(e){
				var boxSize = $("#chipSize").text()
				var thisInput = $("#chipSize"); 
				dropInputLists(thisInput, "chipSizeList", 0, -1, 0);
				e.stopPropagation();
			});
			$("#chipSizeList li").click(function(){
				chipSize = parseInt($(this).text());
				$("#chipSize").text(chipSize)
				chipInfo.chipSize = chipSize;
				chipInfo.halfChipSize = chipSize/2;
				chipInfo.offset = (255 - chipSize)/2;
				chipInfo.canvasHeight = chipSize+17;
				chipInfo.dateYpos = chipSize+12;
				chipInfo.dateXpos = chipSize*0.39;
				
				$("#chipSizeList").hide();
				$("canvas").remove();
				appendChips();
				updateChipInfo();
				drawAllChips();
			});
			
			///////////DEFINE THE FUNCTION TO ADD THE CANVAS AND IMAGE FOR EACH CHIP ON-THE-FLY////////////
			function appendChips(){
				var appendThisCanvas = "",
					appendThisImg = "";
					
				for(var i=0; i<n_chips; i++){
					chipInfo.chips.canvasIDs.push("chip"+i)
					chipInfo.chips.imgIDs.push("img"+i)
					appendThisCanvas = '<canvas class="unselected" id="'+chipInfo.chips.canvasIDs[i]+'" width="'+chipInfo.chipSize+'" height="'+chipInfo.canvasHeight+'"></canvas>'; // style="border:1px solid #d3d3d3;"
					$("#chip-gallery").append(appendThisCanvas);
					appendThisImg = '<img id="'+chipInfo.chips.imgIDs[i]+'"src="'+images[i]+'">';
					$("#img-gallery").append(appendThisImg);
				}
				$("#chip0, #chip"+(n_chips-1)).removeClass("unselected").addClass("selected")
			}

			
			//function to run functions that need all the elements to be loaded - also need to do them in order was the window is loaded
			function start(){
				makeChipInfo();
				drawAllChips();
			}


			////////////////DEFINE FUNCTION TO INITIALLY POPULATE CHIPINFO OBJECT/////////////////////////////////////
			function makeChipInfo(){
				for(var i=0; i < n_chips; i++){					
					//randomly select a chip from a strip to display - not needed once we have json file to tell us
					var thisimg = document.getElementById(chipInfo.chips.imgIDs[i]),
						thisManyChips = thisimg.naturalHeight/255,
						useThisChip = Math.floor((Math.random() * thisManyChips)); 
					
					//define/store some other info needed for zooming
					chipInfo.chips.chipsInStrip.push(thisManyChips);
					chipInfo.chips.useThisChip.push(useThisChip);
					
					//chipInfo.chips.sxOrig.push(chipInfo.offset);	//0 chipInfo.offset set/push the original source x offset to the sxOrig array
					//chipInfo.chips.syOrig.push((255*useThisChip)+chipInfo.offset); // +chipInfo.offset   set/push the original source y offset to the syOrig array
					//chipInfo.chips.sWidthOrig.push(chipInfo.chipSize); //255  set/push the original source x width to the sWidthOrig array
					//chipInfo.chips.sxZoom.push(chipInfo.chips.sxOrig[i]);
					//chipInfo.chips.syZoom.push(chipInfo.chips.syOrig[i]);
					//chipInfo.chips.sWidthZoom.push(chipInfo.chips.sWidthOrig[i]);					
				}
				
				updateChipInfo()

					
				//fill in zoom adjustment arrays sAdj and lwAdj
				//var starter = chipInfo.halfChipSize,
				//	lwstarter = chipInfo.box;
		
				//for(var i=1; i<maxZoom+1; i++){
				//	starter *= 0.9 
				//	sAdj.push(chipInfo.halfChipSize-starter); 
				//	lwstarter /= 0.9
				//	lwAdj.push(lwstarter)
				//}
			}
			
			
			////////////////DEFINE FUNCTION TO UPDATE THE CHIPINFO OBJECT WHEN A NEW CHIP SIZE IS SELECTED////////////
			function updateChipInfo(){
				for(var i=0; i < n_chips; i++){										
					//define/store some other info needed for zooming
					chipInfo.chips.sxOrig[i] = chipInfo.offset;	//0 chipInfo.offset set/push the original source x offset to the sxOrig array
					chipInfo.chips.syOrig[i] = (255*chipInfo.chips.useThisChip[i])+chipInfo.offset; // +chipInfo.offset   set/push the original source y offset to the syOrig array
					chipInfo.chips.sWidthOrig[i] = chipInfo.chipSize; //255  set/push the original source x width to the sWidthOrig array
					chipInfo.chips.sxZoom[i] = chipInfo.chips.sxOrig[i];
					chipInfo.chips.syZoom[i] = chipInfo.chips.syOrig[i];
					chipInfo.chips.sWidthZoom[i] = chipInfo.chips.sWidthOrig[i];					
				}
				
				var starter = chipInfo.halfChipSize,
					lwstarter = chipInfo.box;
									
				for(var i=1; i<maxZoom+1; i++){
					starter *= 0.9 
					sAdj[i] = (chipInfo.halfChipSize-starter);
					lwstarter /= 0.9;
					lwAdj[i] = lwstarter;
				}
			}
						
			
			////////////////DEFINE FUNCTION TO DRAW ALL THE IMAGE CHIPS TO THE CANVASES/////////////////////
			function drawAllChips(){
				updateZoom();
				for(var i=0; i<n_chips; i++){drawOneChip(i)}
			}

			
			////////////DEFINE FUNCTION TO DRAW A NEW IMAGE SECTION TO A CANVAS////////////////////////////
			function drawOneChip(thisChip){
				var canvasID = {}, //canvas id for a given chip
					imgID = {}, //img id for a given chip
					ctx = {}; //img id for a given chip 
				
				canvasID = document.getElementById(chipInfo.chips.canvasIDs[thisChip]);
				imgID = document.getElementById(chipInfo.chips.imgIDs[thisChip]);
				ctx = canvasID.getContext("2d");
				ctx.clearRect(0, 0, canvasID.width, canvasID.height);
				ctx.mozImageSmoothingEnabled = false;
				ctx.msImageSmoothingEnabled = false;
				ctx.imageSmoothingEnabled = false;
				
				
				ctx.drawImage(
					imgID,
					chipInfo.chips.sxZoom[thisChip],
					chipInfo.chips.syZoom[thisChip],
					chipInfo.chips.sWidthZoom[thisChip],
					chipInfo.chips.sWidthZoom[thisChip],
					0,0,chipInfo.chipSize,chipInfo.chipSize); //chipInfo.offset,chipInfo.offset
				ctx.strokeStyle="#FF0000";
				ctx.lineWidth=1;
				ctx.lineCap = 'square';
				ctx.strokeRect(chipInfo.halfChipSize-(chipInfo.boxZoom/2), chipInfo.halfChipSize-(chipInfo.boxZoom/2), chipInfo.boxZoom, chipInfo.boxZoom);
				ctx.font = "11px";
				ctx.fillText("Image Date",chipInfo.dateXpos,chipInfo.dateYpos); //NEED TO GET THE "IMAGE DATE" PASSED IN AS A PARAMETER FROM THE JSON OBJECT OR SIMILAR
			}
			
							
			////////////REPLACE A CHIP WITH ONE SELECTED IN THE REMOTE WINDOW//////////////////////////////
			function replaceChip(replaceThisChip,newSyOffset){
				//adjust the chip offset for the orig and zoom arrays
				chipInfo.chips.syOrig[replaceThisChip] = newSyOffset //set the new original offset
				chipInfo.chips.syZoom[replaceThisChip] = chipInfo.chips.syOrig[replaceThisChip]+sAdj[chipInfo.zoomLevel]; //set the new zoom offset
				
				//draw the new chip
				drawOneChip(replaceThisChip)	
			}
			/////////////////////////////////////////////////////////////////////////////////////////////////
			
			
			function updateZoom(){
				for(var i=0; i<n_chips; i++){
					chipInfo.chips.sxZoom[i] = chipInfo.chips.sxOrig[i]+sAdj[chipInfo.zoomLevel];
					chipInfo.chips.syZoom[i] = chipInfo.chips.syOrig[i]+sAdj[chipInfo.zoomLevel];
					chipInfo.chips.sWidthZoom[i] = chipInfo.chips.sWidthOrig[i]-(sAdj[chipInfo.zoomLevel]*2);
				}
				chipInfo.boxZoom = lwAdj[chipInfo.zoomLevel];
			}
  
			
			$(document).ready(function(){ //not sure if this $(document).ready check is needed, but doesn't hurt
				$(document).on("mousewheel","canvas",function(e){
					if(e.shiftKey){ //
						e.preventDefault(); //make sure that default browser behaviour is prevented
						if(e.deltaX <= -1 || e.deltaY >= 1){zoomIn = 1} else {zoomIn = 0}
						if(zoomIn > 0){
							if (chipInfo.zoomLevel < maxZoom & chipInfo.zoomLevel < stopZoom){chipInfo.zoomLevel++;}
						} else {
							if (chipInfo.zoomLevel > minZoom){chipInfo.zoomLevel--;}
						}

						//redraw the chips
						//updateZoom(); //update the zoom arrays	
						drawAllChips(); //redraw the chips with the new zoom
						
						//prepare zoom message
						zoomInfo = {
							"action":"zoom",
							"zoomLevel":chipInfo.zoomLevel
						}

						//send the zoom array to the external window
						if ((chipstripwindow != null) && chipstripwindow.closed == false){ 
							//prepare zoom message
							zoomInfo = {
								"action":"zoom",
								"zoomLevel":chipInfo.zoomLevel
							}
							//send the zoom message
							chipstripwindow.postMessage(JSON.stringify(zoomInfo),"*");
						}		
					}
				});
			});
			
			
			//make the chip gallery expand on click
			$(document).ready(function(){
				$("#chip-gallery").click(function(e){
					if(!e.ctrlKey && !e.shiftKey){
						var status = $(this).css("height");
						if(status == "565px"){
							$(this).css("height","auto");
						} else {
							$(this).css("height","565px");
						}
					}
					
				});
			});
			
			$(document).ready(function(){
				$("#chip-gallery canvas").click(function(e){
					if(e.shiftKey){
						if($("tr").hasClass("active") == false){
							e.preventDefault(); //make sure that default browser behaviour is prevented
							var canvasIndex = $("#chip-gallery canvas").index(this)
							if(canvasIndex != 0 &&  canvasIndex != len-1){
								var status = $(this).attr("class");
								
								if(status == "unselected"){
									$(this).attr("class","selected");
									//changePlotLine();	
								} else {
									$(this).attr("class","unselected");
									//changePlotLine();
								}	
							}
						}
					}
				});
			});
			
			
			
			
			///////////////////OPEN THE REMOTE CHIP STRIP WINDOW AND SEND MESSAGES/////////////////////
			var chipstripwindow = null ;//keep track of whether the chipstrip window is open or not so it is not opened in multiple new window on each chip click
			$("body").on("click", "canvas", function(e){ //need to use body because the canvases have probably not loaded yet
				if (e.ctrlKey) { 					
					var thisImg = (parseInt($(this).attr("id").replace( /^\D+/g, ''))); //extract the chip index
					var pass_data = {
						"action":"add_chips", //hard assign
						"n_chips":chipInfo.chips.chipsInStrip[thisImg], //"n_chips":"40", //get this from the img metadata
						"src":images[thisImg], //"src":"chips/chips_2012.png", //get this from the id of the .chipholder clicked
						"canvasID":$(this).attr("id"),
						"zoomLevel":chipInfo.zoomLevel
					};
					
					if ((chipstripwindow == null) || (chipstripwindow.closed)){      //if the window is not loaded then load it and send the message after it is fully loaded
						chipstripwindow = window.open("./chip_strip_5.html","_blank","width=1080px, height=840px", "toolbar=0","titlebar=0","menubar=0","scrollbars=yes"); //open the remote chip strip window
						$(chipstripwindow).load(function(){chipstripwindow.postMessage(JSON.stringify(pass_data),"*");}); //wait until the remote window finishes loading before sending the message
					} else {                                                         //else if the window is already loaded, just send the message - no need to wait
						chipstripwindow.postMessage(JSON.stringify(pass_data),"*");
					}
				}
			});
			
			
			//////////////////////////GET MESSAGES FROM REMOTE////////////////////////////////////////////
			//receive messages from the origin window
			$(window).on("message onmessage",function(e){
				var pass_data = JSON.parse(e.originalEvent.data);
				if(pass_data.action == "replace_chip"){
					replaceChip(pass_data.originChipIndex, pass_data.newSyOffset); //replace a chip with one selected in the remote window
					//$(document).ready(function(){drawAllChips()}); //wait until the image has loaded and then draw the chips
				} else if (pass_data.action == "zoom"){
					chipInfo.zoomLevel = pass_data.zoomLevel;
					//updateZoom();
					drawAllChips();
				}
				
				//$("#message").append(e.originalEvent.data); //****need to use 'originalEvent' instead of 'event' since im using jquery to bind the event. the jquery event object is different from the javascript event object - originalEvent is a copied version of the original javascript event object
			});	

			
			/////////////////////////LOAD THE CHIPS////////////////////////////////////////////////////////
			appendChips();
			window.onload = start;
		
		</script>
	</body>
</html>